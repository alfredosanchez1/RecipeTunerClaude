import React, { useState, useEffect } from 'react';
import { ScrollView, Alert, Text, View, Modal, StyleSheet } from 'react-native';
import { TextInput, Button, Switch, Card, Title, Paragraph } from 'react-native-paper';
import { useNavigation } from '@react-navigation/native';
import { useUser } from '../../context/UserContext';
import { useAuth } from '../../context/AuthContext';
import { SettingsSection, UserProfileHeader, AppInfoSection } from '../../components';
import { globalStyles } from '../../styles/globalStyles';
import { useRealmDatabase } from '../../hooks/useRealmDatabase';
import { supabase } from '../../services/supabase/client';

const SettingsScreen = () => {
  const navigation = useNavigation();
  const { user, setUser, resetUserData } = useUser();
  const { signOut } = useAuth();
  const { testDatabase, isInitialized } = useRealmDatabase();

  // Estados para modales
  const [changePasswordModal, setChangePasswordModal] = useState(false);
  const [exportDataModal, setExportDataModal] = useState(false);

  // Estados para formularios
  const [passwordForm, setPasswordForm] = useState({
    currentPassword: '',
    newPassword: '',
    confirmPassword: ''
  });

  const [notifications, setNotifications] = useState({
    mealReminders: true,
    healthAlerts: true,
    recipeUpdates: false
  });

  // Estados de carga
  const [loading, setLoading] = useState(false);

  // Funci√≥n para probar Realm Database
  const handleTestDatabase = async () => {
    try {
      const result = await testDatabase();

      if (result.success) {
        const message = `Realm Database funciona perfectamente\n\nTests ejecutados:\n${result.tests.map(test => `- ${test}`).join('\n')}\n\nTimestamp: ${result.timestamp}`;
        Alert.alert('‚úÖ Prueba Exitosa', message);
      } else {
        Alert.alert('‚ùå Error en Test', result.message);
      }
    } catch (error) {
      console.error('‚ùå Error en prueba de Realm Database:', error);
      Alert.alert('‚ùå Error', 'Error al probar Realm Database: ' + error.message);
    }
  };

  // Funci√≥n alternativa para probar Realm Database
  const handleTestDatabaseAlt = async () => {
    try {
      const result = await testDatabase();

      if (result.success) {
        const message = `Realm Database funciona perfectamente\n\nTests ejecutados:\n- Inicializaci√≥n\n- Crear objeto\n- Leer objeto\n- Eliminar objeto\n\nTimestamp: ${result.timestamp}`;
        Alert.alert('‚úÖ Prueba Exitosa', message);
      } else {
        Alert.alert('‚ùå Error en Test', result.message);
      }
    } catch (error) {
      console.error('‚ùå Error en prueba de Realm Database:', error);
      Alert.alert('‚ùå Error', 'Error al probar Realm Database: ' + error.message);
    }
  };


  // Funci√≥n para abrir modal de cambio de contrase√±a
  const handleChangePassword = () => {
    setPasswordForm({
      currentPassword: '',
      newPassword: '',
      confirmPassword: ''
    });
    setChangePasswordModal(true);
  };

  // Funci√≥n para cambiar contrase√±a con sincronizaci√≥n completa en Supabase
  const handleSavePassword = async () => {
    // Validaciones de entrada
    if (!passwordForm.newPassword || !passwordForm.confirmPassword) {
      Alert.alert('Error', 'Por favor completa todos los campos');
      return;
    }

    if (passwordForm.newPassword !== passwordForm.confirmPassword) {
      Alert.alert('Error', 'Las contrase√±as no coinciden');
      return;
    }

    if (passwordForm.newPassword.length < 6) {
      Alert.alert('Error', 'La contrase√±a debe tener al menos 6 caracteres');
      return;
    }

    // Validaci√≥n de fortaleza de contrase√±a
    const hasNumber = /\d/.test(passwordForm.newPassword);
    const hasUpper = /[A-Z]/.test(passwordForm.newPassword);
    const hasLower = /[a-z]/.test(passwordForm.newPassword);

    if (!hasNumber || !hasUpper || !hasLower) {
      Alert.alert(
        'Contrase√±a d√©bil',
        'La contrase√±a debe contener al menos:\n‚Ä¢ Una letra may√∫scula\n‚Ä¢ Una letra min√∫scula\n‚Ä¢ Un n√∫mero',
        [
          { text: 'Continuar de todas formas', onPress: () => proceedWithPasswordChange() },
          { text: 'Cambiar contrase√±a', style: 'cancel' }
        ]
      );
      return;
    }

    await proceedWithPasswordChange();
  };

  const proceedWithPasswordChange = async () => {
    setLoading(true);
    try {
      console.log('üîê SETTINGS - Iniciando cambio de contrase√±a en Supabase...');

      // Verificar que el usuario est√° autenticado
      const { data: { user: currentUser }, error: userError } = await supabase.auth.getUser();

      if (userError || !currentUser) {
        throw new Error('No se pudo verificar la sesi√≥n actual');
      }

      console.log('‚úÖ SETTINGS - Usuario verificado, actualizando contrase√±a...');

      // Actualizar contrase√±a en Supabase Auth
      const { data, error } = await supabase.auth.updateUser({
        password: passwordForm.newPassword
      });

      if (error) {
        console.error('‚ùå SETTINGS - Error de Supabase:', error);
        throw error;
      }

      console.log('‚úÖ SETTINGS - Contrase√±a actualizada exitosamente en Supabase');

      // Verificar que la sesi√≥n sigue activa despu√©s del cambio
      const { data: { user: updatedUser }, error: verifyError } = await supabase.auth.getUser();

      if (verifyError || !updatedUser) {
        console.warn('‚ö†Ô∏è SETTINGS - Sesi√≥n afectada por cambio de contrase√±a, pero cambio exitoso');
      } else {
        console.log('‚úÖ SETTINGS - Sesi√≥n verificada post-cambio de contrase√±a');
      }

      // Limpiar formulario y cerrar modal
      setChangePasswordModal(false);
      setPasswordForm({
        currentPassword: '',
        newPassword: '',
        confirmPassword: ''
      });

      // Mostrar confirmaci√≥n al usuario
      Alert.alert(
        'üîê Contrase√±a Actualizada',
        'Tu contrase√±a ha sido cambiada exitosamente. La nueva contrase√±a est√° sincronizada con el servidor.',
        [
          {
            text: 'Entendido',
            onPress: () => {
              console.log('‚úÖ SETTINGS - Cambio de contrase√±a completado exitosamente');
            }
          }
        ]
      );

    } catch (error) {
      console.error('‚ùå SETTINGS - Error cambiando contrase√±a:', error);

      let errorMessage = 'No se pudo cambiar la contrase√±a.';

      if (error.message.includes('Invalid login credentials')) {
        errorMessage = 'La contrase√±a actual es incorrecta.';
      } else if (error.message.includes('Password should be at least 6 characters')) {
        errorMessage = 'La contrase√±a debe tener al menos 6 caracteres.';
      } else if (error.message.includes('network')) {
        errorMessage = 'Error de conexi√≥n. Verifica tu internet y vuelve a intentar.';
      } else if (error.message) {
        errorMessage = error.message;
      }

      Alert.alert('Error al Cambiar Contrase√±a', errorMessage);
    } finally {
      setLoading(false);
    }
  };

  // Funci√≥n para exportar datos del usuario
  const handleExportData = () => {
    setExportDataModal(true);
  };

  // Funci√≥n para realizar exportaci√≥n de datos
  const handleConfirmExport = async () => {
    setLoading(true);
    try {
      // Obtener todas las recetas del usuario
      const { data: recipes, error: recipesError } = await supabase
        .from('recipetuner_recipes')
        .select(`
          *,
          nutrition_info:recipetuner_nutrition_info(*)
        `)
        .eq('app_name', 'recipetuner');

      if (recipesError) throw recipesError;

      // Obtener preferencias del usuario
      const { data: { user: authUser } } = await supabase.auth.getUser();
      const { data: preferences, error: prefsError } = await supabase
        .from('recipetuner_user_preferences')
        .select('*')
        .eq('user_id', authUser.id)
        .single();

      const exportData = {
        exportDate: new Date().toISOString(),
        user: {
          name: user?.name,
          email: user?.email
        },
        preferences: preferences,
        recipes: recipes,
        totalRecipes: recipes?.length || 0,
        adaptedRecipes: recipes?.filter(r => r.is_adapted).length || 0
      };

      // Crear JSON formateado
      const jsonString = JSON.stringify(exportData, null, 2);

      setExportDataModal(false);
      Alert.alert(
        'Datos Exportados',
        `Se exportaron ${recipes?.length || 0} recetas y tus preferencias. Los datos est√°n listos para ser compartidos.`,
        [
          {
            text: 'Copiar al Portapapeles',
            onPress: async () => {
              try {
                // En React Native necesitar√≠as usar @react-native-clipboard/clipboard
                // Por ahora solo mostramos el resultado
                console.log('Datos exportados:', jsonString);
                Alert.alert('Copiado', 'Datos copiados al portapapeles');
              } catch (error) {
                Alert.alert('Error', 'No se pudieron copiar los datos');
              }
            }
          },
          { text: 'OK' }
        ]
      );
    } catch (error) {
      console.error('Error exportando datos:', error);
      Alert.alert('Error', 'No se pudieron exportar los datos: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  // Funci√≥n de logout
  const handleLogout = () => {
    Alert.alert(
      'Cerrar Sesi√≥n',
      '¬øEst√°s seguro de que deseas cerrar sesi√≥n?',
      [
        { text: 'Cancelar', style: 'cancel' },
        { text: 'Cerrar Sesi√≥n', style: 'destructive', onPress: async () => {
          try {
            console.log('üîì SETTINGS - Iniciando logout...');
            await signOut();
            await resetUserData();
            Alert.alert('Sesi√≥n Cerrada', 'Has cerrado sesi√≥n exitosamente');
          } catch (error) {
            console.error('‚ùå SETTINGS - Error en logout:', error);
            Alert.alert('Error', 'No se pudo cerrar sesi√≥n: ' + error.message);
          }
        }},
      ]
    );
  };


  const settingSections = [
    {
      title: 'Cuenta',
      items: [
        {
          label: 'Cambiar Contrase√±a',
          onPress: handleChangePassword,
          icon: 'lock'
        }
      ]
    },
    {
      title: 'Notificaciones',
      items: [
        {
          label: 'Recordatorios de Comidas',
          type: 'switch',
          value: notifications.mealReminders,
          onValueChange: (value) => setNotifications(prev => ({...prev, mealReminders: value})),
          icon: 'bell'
        },
        {
          label: 'Alertas de Salud',
          type: 'switch',
          value: notifications.healthAlerts,
          onValueChange: (value) => setNotifications(prev => ({...prev, healthAlerts: value})),
          icon: 'medical-bag'
        },
        {
          label: 'Actualizaciones de Recetas',
          type: 'switch',
          value: notifications.recipeUpdates,
          onValueChange: (value) => setNotifications(prev => ({...prev, recipeUpdates: value})),
          icon: 'refresh'
        }
      ]
    },
    {
      title: 'Datos',
      items: [
        {
          label: 'Exportar Mis Datos',
          onPress: handleExportData,
          icon: 'download'
        }
      ]
    },
    {
      title: 'Cuenta',
      items: [
        {
          label: 'üîì Cerrar Sesi√≥n',
          onPress: handleLogout,
          icon: 'logout'
        }
      ]
    },
    {
      title: 'Desarrollo',
      items: [
        {
          label: 'üß™ Probar Realm Database',
          onPress: handleTestDatabase,
          icon: 'database'
        },
        {
          label: 'üß™ Probar Realm Database (Alt)',
          onPress: handleTestDatabaseAlt,
          icon: 'database-outline'
        }
      ]
    }
  ];

  // Debug: Mostrar las secciones en consola
  useEffect(() => {
    console.log('üîç SettingsScreen - Secciones disponibles:', settingSections.map(s => s.title));
    console.log('üîç SettingsScreen - Secci√≥n Desarrollo:', settingSections.find(s => s.title === 'Desarrollo'));
  }, []);

  return (
    <>
      <ScrollView style={globalStyles.container}>
        <UserProfileHeader user={user} />

        {settingSections.map((section, index) => (
          <SettingsSection key={index} title={section.title} items={section.items} />
        ))}

        <AppInfoSection />
      </ScrollView>


      {/* Modal de Cambiar Contrase√±a */}
      <Modal
        visible={changePasswordModal}
        animationType="slide"
        presentationStyle="pageSheet"
      >
        <View style={styles.modalContainer}>
          <Card style={styles.modalCard}>
            <Card.Content>
              <Title style={styles.modalTitle}>üîê Cambiar Contrase√±a</Title>

              <Paragraph style={styles.modalText}>
                Tu nueva contrase√±a se sincronizar√° autom√°ticamente con el servidor de forma segura.
              </Paragraph>

              <TextInput
                label="Nueva Contrase√±a"
                value={passwordForm.newPassword}
                onChangeText={(text) => setPasswordForm(prev => ({...prev, newPassword: text}))}
                style={styles.input}
                mode="outlined"
                secureTextEntry
                right={<TextInput.Icon icon="eye" />}
                helper="M√≠nimo 6 caracteres. Recomendado: may√∫sculas, min√∫sculas y n√∫meros"
              />

              <TextInput
                label="Confirmar Nueva Contrase√±a"
                value={passwordForm.confirmPassword}
                onChangeText={(text) => setPasswordForm(prev => ({...prev, confirmPassword: text}))}
                style={styles.input}
                mode="outlined"
                secureTextEntry
                right={<TextInput.Icon icon="eye" />}
                error={passwordForm.confirmPassword && passwordForm.newPassword !== passwordForm.confirmPassword}
                helper={passwordForm.confirmPassword && passwordForm.newPassword !== passwordForm.confirmPassword ? "Las contrase√±as no coinciden" : ""}
              />

              <View style={styles.passwordInfo}>
                <Text style={styles.infoTitle}>üìã Informaci√≥n importante:</Text>
                <Text style={styles.infoText}>‚Ä¢ La contrase√±a se actualizar√° en Supabase inmediatamente</Text>
                <Text style={styles.infoText}>‚Ä¢ Tu sesi√≥n permanecer√° activa despu√©s del cambio</Text>
                <Text style={styles.infoText}>‚Ä¢ Usa la nueva contrase√±a para futuros inicios de sesi√≥n</Text>
              </View>

              <View style={styles.modalButtons}>
                <Button
                  mode="outlined"
                  onPress={() => {
                    setChangePasswordModal(false);
                    setPasswordForm({
                      currentPassword: '',
                      newPassword: '',
                      confirmPassword: ''
                    });
                  }}
                  style={styles.modalButton}
                  disabled={loading}
                >
                  Cancelar
                </Button>
                <Button
                  mode="contained"
                  onPress={handleSavePassword}
                  style={styles.modalButton}
                  loading={loading}
                  disabled={loading || !passwordForm.newPassword || !passwordForm.confirmPassword}
                  icon="shield-check"
                >
                  {loading ? 'Actualizando...' : 'Cambiar Contrase√±a'}
                </Button>
              </View>
            </Card.Content>
          </Card>
        </View>
      </Modal>

      {/* Modal de Exportar Datos */}
      <Modal
        visible={exportDataModal}
        animationType="slide"
        presentationStyle="pageSheet"
      >
        <View style={styles.modalContainer}>
          <Card style={styles.modalCard}>
            <Card.Content>
              <Title style={styles.modalTitle}>Exportar Mis Datos</Title>

              <Paragraph style={styles.modalText}>
                Se exportar√°n todos tus datos incluyendo:
              </Paragraph>

              <View style={styles.exportList}>
                <Text style={styles.exportItem}>‚Ä¢ Todas tus recetas</Text>
                <Text style={styles.exportItem}>‚Ä¢ Recetas adaptadas con IA</Text>
                <Text style={styles.exportItem}>‚Ä¢ Informaci√≥n nutricional</Text>
                <Text style={styles.exportItem}>‚Ä¢ Preferencias diet√©ticas</Text>
                <Text style={styles.exportItem}>‚Ä¢ Configuraciones de usuario</Text>
              </View>

              <Paragraph style={styles.modalWarning}>
                Los datos se exportar√°n en formato JSON. Puedes guardar este archivo como respaldo o para importar en otra cuenta.
              </Paragraph>

              <View style={styles.modalButtons}>
                <Button
                  mode="outlined"
                  onPress={() => setExportDataModal(false)}
                  style={styles.modalButton}
                  disabled={loading}
                >
                  Cancelar
                </Button>
                <Button
                  mode="contained"
                  onPress={handleConfirmExport}
                  style={styles.modalButton}
                  loading={loading}
                  disabled={loading}
                  icon="download"
                >
                  Exportar
                </Button>
              </View>
            </Card.Content>
          </Card>
        </View>
      </Modal>
    </>
  );
};

const styles = StyleSheet.create({
  modalContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    padding: 20,
  },
  modalCard: {
    width: '100%',
    maxWidth: 400,
    backgroundColor: '#fff',
    borderRadius: 12,
    elevation: 8,
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 4,
    },
    shadowOpacity: 0.25,
    shadowRadius: 4,
  },
  modalTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    textAlign: 'center',
    marginBottom: 20,
    color: '#333',
  },
  input: {
    marginBottom: 15,
  },
  modalButtons: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginTop: 20,
    gap: 15,
  },
  modalButton: {
    flex: 1,
  },
  modalText: {
    fontSize: 16,
    marginBottom: 15,
    color: '#555',
  },
  exportList: {
    backgroundColor: '#f8f9fa',
    padding: 15,
    borderRadius: 8,
    marginBottom: 15,
  },
  exportItem: {
    fontSize: 14,
    color: '#333',
    marginBottom: 8,
    paddingLeft: 10,
  },
  modalWarning: {
    fontSize: 14,
    color: '#666',
    fontStyle: 'italic',
    textAlign: 'center',
    marginBottom: 15,
  },
  passwordInfo: {
    backgroundColor: '#e3f2fd',
    padding: 15,
    borderRadius: 8,
    marginBottom: 20,
    borderLeftWidth: 4,
    borderLeftColor: '#2196f3',
  },
  infoTitle: {
    fontSize: 14,
    fontWeight: 'bold',
    color: '#1565c0',
    marginBottom: 8,
  },
  infoText: {
    fontSize: 13,
    color: '#1976d2',
    marginBottom: 4,
    paddingLeft: 10,
  },
});

export default SettingsScreen;